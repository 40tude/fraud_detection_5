# Implementation Plan: Consumer Batch Processing

**Branch**: `002-consumer-transactions` | **Date**: 2026-02-22 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/specs/002-consumer-transactions/spec.md`

## Summary

Consumer reads variable-size batches from Buffer1, sends them to Modelizer for fraud inference, triggers best-effort alarms for fraudulent transactions, and writes all inferred transactions to Buffer2. Four hexagonal ports (Buffer1Read, Modelizer, Alarm, Buffer2) keep the Consumer decoupled from concrete implementations. Model version switching is delegated to the Modelizer port.

## Technical Context

**Language/Version**: Rust edition 2024
**Primary Dependencies**: tokio 1 (async), thiserror 2 (lib errors), log 0.4 (logging), rand 0.9 (batch-size RNG), uuid 1
**Storage**: N/A (in-memory adapters for proof-of-concept)
**Testing**: `cargo test --workspace` (TDD per constitution)
**Target Platform**: Windows 11
**Project Type**: library crate (consumer) + binary crate (fraud_detection)
**Performance Goals**: proof-of-concept; no specific throughput targets
**Constraints**: single-threaded tokio runtime (`current_thread`); no dyn dispatch
**Scale/Scope**: didactic project; 4 crates + 1 binary

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Evidence |
|-----------|--------|----------|
| I. Hexagonal Architecture | PASS | 4 port traits in domain; Consumer depends only on traits |
| II. Modular Monolith | PASS | New `consumer` lib crate; workspace member |
| III. TDD (NON-NEGOTIABLE) | PASS | All behavior via Red-Green-Refactor |
| IV. Pedagogical Clarity | PASS | Composition over cleverness; explicit generics |
| V. Async Pipeline + Variable Batching | PASS | N2 in `[1, N2_MAX]` per iteration; async ports |

**Post-Phase-1 re-check**: All 5 principles satisfied. No violations.

## Project Structure

### Documentation (this feature)

```text
specs/002-consumer-transactions/
+-- plan.md              # This file
+-- research.md          # Phase 0: design decisions
+-- data-model.md        # Phase 1: entity and trait definitions
+-- quickstart.md        # Phase 1: build/run instructions
+-- tasks.md             # Phase 2: generated by /speckit.tasks
```

### Source Code (repository root)

```text
Cargo.toml                              # workspace: add consumer member
crates/
+-- domain/
|   +-- Cargo.toml
|   +-- src/
|       +-- lib.rs                      # ADD: InferredTransaction, ModelVersion,
|                                       #      ModelizerError, AlarmError,
|                                       #      Buffer1Read, Buffer2, Modelizer, Alarm
+-- consumer/                           # NEW crate
|   +-- Cargo.toml
|   +-- src/
|       +-- lib.rs                      # Consumer, ConsumerConfig, ConsumerError
+-- producer/
|   +-- Cargo.toml                      # (unchanged)
|   +-- src/
|       +-- lib.rs                      # (unchanged)
+-- fraud_detection/
    +-- Cargo.toml                      # ADD: consumer dependency
    +-- src/
        +-- adapters/
        |   +-- mod.rs                  # ADD: new adapter modules
        |   +-- in_memory_buffer.rs     # UPDATE: implement Buffer1Read
        |   +-- in_memory_buffer2.rs    # NEW: Buffer2 adapter
        |   +-- demo_modelizer.rs       # NEW: Modelizer adapter (demo, DemoModelizer)
        |   +-- log_alarm.rs           # NEW: Alarm adapter (log-based)
        +-- main.rs                     # UPDATE: wire Consumer
```

**Structure Decision**: Cargo workspace with 4 lib crates + 1 binary. Consumer is a new workspace member following the Producer pattern exactly. Mock/demo adapters live in the binary crate (hexagonal: adapters are outside domain).

## Key Design Decisions

See [research.md](research.md) for full rationale on each decision.

1. **BufferError reused** for all buffer operations (read and write, Buffer1 and Buffer2)
2. **4 generic type params** on Consumer methods (one per port)
3. **Best-effort alarms**: `consume_once` returns `Result<Vec<AlarmError>, ConsumerError>`
4. **InferredTransaction** wraps `Transaction` via composition
5. **Consumer does not store model version state**; pass-through to Modelizer
6. **Lib crates use `thiserror` + `log`**; binary uses `anyhow` + `env_logger`
7. **No `#[from]` on ConsumerError::Read/Write** (same source type); manual `.map_err()`

## Complexity Tracking

> No constitution violations. Table intentionally empty.

| Violation | Why Needed | Simpler Alternative Rejected Because |
|-----------|------------|-------------------------------------|
| (none) | -- | -- |
